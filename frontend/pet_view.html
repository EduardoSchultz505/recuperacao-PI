<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Detalhes do Pet - PetCard</title>
  <link rel="stylesheet" href="pet_view.css" />
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>

  <main class="pet-container">
    <section class="pet-info">
      <button id="config-btn" class="config-btn">‚öôÔ∏è</button>
      <img id="pet-foto" src="" alt="Foto do Pet" />
      <h2 id="pet-nome"></h2>
      <ul>
        <li><b>Ra√ßa:</b> <span id="pet-raca"></span></li>
        <li><b>G√™nero:</b> <span id="pet-genero"></span></li>
        <li><b>Idade:</b> <span id="pet-idade"></span> anos</li>
        <li><b>Cor:</b> <span id="pet-cor"></span></li>
      </ul>
    </section>

    <section id="edit-section" class="hidden">
      <h3>Editar Pet</h3>
      <form id="edit-pet-form" enctype="multipart/form-data">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required />

        <label for="idade">Idade (anos)</label>
        <input type="number" id="idade" name="idade" min="0" max="30" required />

        <label for="genero">G√™nero</label>
        <select id="genero" name="genero" required>
          <option value="macho">Macho</option>
          <option value="f√™mea">F√™mea</option>
        </select>

        <label for="raca">Ra√ßa</label>
        <input type="text" id="raca" name="raca" />

        <label for="cor">Cor</label>
        <input type="text" id="cor" name="cor" />

        <label for="foto">Foto (opcional)</label>
        <input type="file" id="foto" name="foto" accept="image/*" />

        <button type="submit">Salvar</button>
        <button type="button" id="cancel-btn">Cancelar</button>
      </form>
    </section>

    <div class="event-form-container">
      <h3>Adicionar Evento</h3>
      <form id="event-form">
        <div class="input-group">
          <label for="nome">Nome do Evento *</label>
          <input type="text" id="nome" name="nome" required>
        </div>
        <div class="input-group">
          <label for="data">Data *</label>
          <input type="date" id="data" name="data" required>
        </div>
        <div class="input-group">
          <label for="descricao">Descri√ß√£o</label>
          <textarea id="descricao" name="descricao"></textarea>
        </div>
        <button type="submit">Cadastrar Evento</button>
      </form>
    </div>

    <ul id="event-list"></ul>
  </main>

  <nav class="bottom-nav">
    <a href="pet_list.html">
      <i>üêæ</i>
      <span>Pets</span>
    </a>
    <a href="add_pet.html">
      <i>‚ûï</i>
      <span>Cadastrar</span>
    </a>
    <a href="profile.html">
      <i>üë§</i>
      <span>Perfil</span>
    </a>
  </nav>

  <script>
    const API_URL = 'http://127.0.0.1:5000/pets';
    const params = new URLSearchParams(window.location.search);
    const petId = params.get('id');

    const petFoto = document.getElementById('pet-foto');
    const petNome = document.getElementById('pet-nome');
    const petRaca = document.getElementById('pet-raca');
    const petGenero = document.getElementById('pet-genero');
    const petIdade = document.getElementById('pet-idade');
    const petCor = document.getElementById('pet-cor');

    const configBtn = document.getElementById('config-btn');
    const editSection = document.getElementById('edit-section');
    const editForm = document.getElementById('edit-pet-form');
    const cancelBtn = document.getElementById('cancel-btn');

    const eventForm = document.getElementById('event-form');
    const eventList = document.getElementById('event-list');

    // ------------------- Fun√ß√£o para carregar os dados do pet -------------------
    async function loadPet() {
      try {
        const res = await fetch(`${API_URL}/${petId}`);
        if (!res.ok) throw new Error('Pet n√£o encontrado.');
        const pet = await res.json();

        petFoto.src = pet.foto ? `${API_URL.replace('/pets', '')}/uploads/${pet.foto}` : 'https://via.placeholder.com/150?text=Sem+Foto';
        petNome.textContent = pet.nome;
        petRaca.textContent = pet.raca || '-';
        petGenero.textContent = pet.genero || '-';
        petIdade.textContent = pet.idade || '-';
        petCor.textContent = pet.cor || '-';

        // Preencher formul√°rio
        editForm.nome.value = pet.nome;
        editForm.idade.value = pet.idade;
        editForm.genero.value = pet.genero;
        editForm.raca.value = pet.raca;
        editForm.cor.value = pet.cor;
      } catch (err) {
        alert(err.message);
      }
    }

    // ------------------- Fun√ß√£o para carregar eventos -------------------
    async function loadEvents() {
      const res = await fetch(`${API_URL}/${petId}/events`);
      const events = await res.json();
      eventList.innerHTML = events.map(e => `
      <li>
        <b>${e.nome}</b> - ${e.data}<br>
        ${e.descricao || ''}
        <button class="delete-event" data-id="${e.id}">Excluir</button>
      </li>
    `).join('');

      // Adicionar listener para deletar eventos
      document.querySelectorAll('.delete-event').forEach(btn => {
        btn.addEventListener('click', async () => {
          const eventId = btn.dataset.id;
          if (confirm('Deseja deletar este evento?')) {
            await fetch(`http://127.0.0.1:5000/events/${eventId}`, { method: 'DELETE' });
            loadEvents(); // Recarregar eventos
          }
        });
      });
    }

    // ------------------- Mostrar / esconder formul√°rio de edi√ß√£o -------------------
    configBtn.addEventListener('click', () => {
      editSection.classList.toggle('hidden');
    });

    // Cancelar edi√ß√£o
    cancelBtn.addEventListener('click', () => {
      editSection.classList.add('hidden');
    });

    // Enviar edi√ß√£o
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(editForm);

      try {
        const res = await fetch(`${API_URL}/${petId}`, {
          method: 'PUT',
          body: formData
        });
        if (!res.ok) throw new Error('Erro ao atualizar pet.');

        alert('Pet atualizado com sucesso!');
        editSection.classList.add('hidden');
        loadPet(); // Recarregar os dados
      } catch (err) {
        alert(err.message);
      }
    });

    // ------------------- Cadastrar evento -------------------
    eventForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(eventForm).entries());

      if (!formData.nome || !formData.data) {
        alert('Nome e data do evento s√£o obrigat√≥rios!');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/${petId}/events`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        if (!res.ok) throw new Error('Erro ao criar evento.');

        eventForm.reset();
        loadEvents(); // Recarregar eventos
      } catch (err) {
        alert(err.message);
      }
    });

    // ------------------- Inicializar -------------------
    loadPet();
    loadEvents();
  </script>


</body>

</html>